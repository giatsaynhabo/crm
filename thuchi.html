<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Danh s√°ch ‚Äî Thu / Chi</title>
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/thuchi.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
/* üå∏ Giao di·ªán t·ªïng th·ªÉ */
body {
  visibility: hidden;
  font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
  background: radial-gradient(circle at top left, #ffa023, #f8b87b);
  color: #333;

}

/* Container & Card */
.container { max-width: 2000px; margin: 36px auto; padding: 0 16px; }
.card {
  background: #fff;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
}
h1 { text-align: center; margin-bottom: 18px; }

/* B·ªô l·ªçc */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: flex-end;
  margin-bottom: 1rem;
}
.filters input,
.filters select {
  padding: 0.4rem 0.6rem;
  font-size: 0.9rem;
  border: 1px solid #d0d7de;
  border-radius: 6px;
  font-family: inherit;
}
.filters button {
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

/* N√∫t */
.btn {
  background: #e6eefc;
  color: #000;
  border: none;
  border-radius: 8px;
  padding: 9px 12px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn:hover { background: #d8e3fa; }
.btn.primary { background: #007bff; color: #fff; }
.btn.warning { background: #ffc107; color: #000; }
.btn.success { background: #28a745; color: #fff; }
.btn.danger { background: #dc3545; color: #fff; }

/* B·∫£ng d·ªØ li·ªáu */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
.data-table th,
.data-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eef1f5;
  text-align: center;
  font-size: 0.9rem;
}
.data-table th {
  background: #f8fafc;
  font-weight: 600;
}
.data-table tbody tr:hover {
  background: #f0f4ff;
}

/* T·ªïng k·∫øt */
#summary {
  margin-top: 1rem;
  font-weight: 500;
  font-size: 1rem;
  text-align: right;
}
/* Ti√™u ƒë·ªÅ & Form */
.popup h2, .popup h3 {
  margin-top: 0;
  margin-bottom: 0.6rem;
  font-weight: 600;
}
.form-group {
  margin-bottom: 0.8rem;
}
.form-group label {
  display: block;
  margin-bottom: 0.3rem;
  font-weight: 500;
}
.form-group input,
.form-group select {
  width: 100%;
  padding: 0.4rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.95rem;
}
input[readonly] { background: #f7f9fc; }

/* Khu v·ª±c n√∫t trong popup */
.popup-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-top: 0.8rem;
}

/* Popup Chi ti·∫øt phi·∫øu */
.history-table-wrapper {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 1rem;
}
#detailHistory {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
#detailHistory th,
#detailHistory td {
  border: 1px solid #ddd;
  padding: 6px 10px;
  text-align: center;
  font-size: 0.85rem;
}
#detailHistory th {
  background: #f5f5f5;
  font-weight: 600;
}

/* Th√¥ng tin chi ti·∫øt */
.detail-row {
  display: flex;
  margin-bottom: 8px;
  align-items: center;
}
.detail-row .label {
  width: 180px;
  font-weight: bold;
  color: #333;
}
.detail-row .value {
  flex: 1;
  padding: 4px 8px;
  background: #f5f5f5;
  border-radius: 4px;
  border: 1px solid #ddd;
}

/* Ph·∫ßn th√™m chi */
#addPaymentSection {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #ccc;
}
#btnCloseDetail {
  margin-top: 10px;
  padding: 6px 12px;
  background: #ff4d4f;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
#btnCloseDetail:hover { background: #d9363e; }

/* SweetAlert lu√¥n n·ªïi tr√™n c√πng */
.swal2-container { z-index: 99999 !important; }

/* Responsive */
@media (max-width: 900px) {
  .filters { flex-direction: column; align-items: stretch; }
  .popup-content { width: 95%; }
}
/* üîπ Popup Edit Phi·∫øu Thu/Chi */
#detailInfo.edit-mode {
  background: #fdfdfd;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
  font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
}

/* Input trong edit mode */
#detailInfo.edit-mode input.editable-input {
  width: 100%;
  padding: 6px 10px;
  margin: 2px 0;
  border: 1px solid #b0c4de;
  border-radius: 6px;
  font-size: 0.95rem;
  background: #f5f7fa;
  transition: border-color 0.2s, box-shadow 0.2s;
  font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
}

#detailInfo.edit-mode input.editable-input:focus {
  border-color: #007bff;
  box-shadow: 0 0 5px rgba(0,123,255,0.3);
  outline: none;
}

/* N√∫t l∆∞u v√† h·ªßy */
#btnSaveEdit, #btnCancelEdit {
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  margin-top: 8px;
  margin-right: 6px;
  transition: background 0.2s;
}

#btnSaveEdit {
  background: #28a745;
  color: #fff;
}
#btnSaveEdit:hover {
  background: #218838;
}

#btnCancelEdit {
  background: #ffc107;
  color: #000;
}
#btnCancelEdit:hover {
  background: #e0a800;
}

/* Khi edit, highlight c√°c label */
#detailInfo.edit-mode .label-value .label {
  font-weight: 600;
  color: #007bff;
}

/* S·∫Øp x·∫øp c√°c row trong edit */
#detailInfo.edit-mode .detail-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 10px;
  align-items: center;
}

/* Responsive cho m√†n h√¨nh nh·ªè */
@media (max-width: 900px) {
  #detailInfo.edit-mode .detail-row {
    flex-direction: column;
  }
}

</style>

<!-- üîí Ki·ªÉm tra quy·ªÅn & ƒë·ªìng b·ªô login -->
<script type="module">
  import { initProtectedPage } from "./js/permissionInit.js";
  // Ch·ªâ g·ªçi 1 h√†m duy nh·∫•t, s·∫Ω x·ª≠ l√Ω:
  // - ·∫®n/hi·ªán body
  // - Ki·ªÉm tra login
  // - Ki·ªÉm tra quy·ªÅn "view" cho "thuchi"
  // - ƒê·ªìng b·ªô UI theo quy·ªÅn
  await initProtectedPage("thuchi", "view");
</script>
</head>
<body>
<div id="menu"></div>

<main class="container">
<h1>üí∞ Danh s√°ch Phi·∫øu Thu / Chi</h1>

<!-- B·ªô l·ªçc -->
<section class="card">
  <div class="filters">
    <div>
      <label>Ch·ªçn ng√†y</label><br/>
      <select id="dateRangeSelect">
        <option value="today">H√¥m nay</option>
        <option value="yesterday">H√¥m qua</option>
        <option value="7days">7 ng√†y tr∆∞·ªõc</option>
        <option value="14days">14 ng√†y tr∆∞·ªõc</option>
        <option value="30days">30 ng√†y tr∆∞·ªõc</option>
        <option value="thisMonth">Th√°ng n√†y</option>
        <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
        <option value="custom">T√πy ch·ªçn</option>
        <option value="all">T·∫•t c·∫£</option>
      </select>
    </div>
    <div>
      <label>T·ª´ ng√†y</label><br/>
      <input type="date" id="fromDate"/>
    </div>
    <div>
      <label>ƒê·∫øn ng√†y</label><br/>
      <input type="date" id="toDate"/>
    </div>
    <div>
      <label>Ng∆∞·ªùi t·∫°o</label><br/>
      <select id="createdByFilter"><option value="">-- T·∫•t c·∫£ --</option></select>
    </div>
    <div>
      <label>Ng∆∞·ªùi thu</label><br/>
      <select id="userThuFilter"><option value="">-- T·∫•t c·∫£ --</option></select>
    </div>
    <div>
      <label>Lo·∫°i giao d·ªãch</label><br/>
      <select id="typeFilter">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="thu">Thu</option>
        <option value="chi">Chi</option>
      </select>
    </div>
    <div>
      <label>Ph∆∞∆°ng th·ª©c</label><br/>
      <select id="paymentFilter">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
        <option value="chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
      </select>
    </div>
    <div>
      <button id="btnFilter" class="btn primary">L·ªçc</button>
      <button id="btnReset" class="btn">Reset</button>
      <button id="btnReload" class="btn warning">üîÑ ƒê·ªìng b·ªô</button>
    </div>
    
    <div style="margin-left:auto">
      <button id="btnExportExcel" class="btn success" data-permission-key="thuchi" data-permission-action="export">üì§ Xu·∫•t Excel</button>
      <button id="btnCreateChi" class="btn success">‚ûï T·∫°o Phi·∫øu Chi</button>
    </div>
  </div>

  <table class="data-table" id="transactionsTable">
    <thead>
      <tr>
        <th>M√£ phi·∫øu</th>
        <th>Lo·∫°i</th>
        <th>ƒê∆°n h√†ng</th>
        <th>User t·∫°o</th>
        <th>User thu/chi</th>
        <th>Ng√†y</th>
        <th>Ph·∫£i thu</th>
        <th>ƒê√£ thu</th>
        <th>C√≤n n·ª£</th>
        <th>Phi·∫øu CT</th>
        <th>Coupon</th>
        <th>Ph∆∞∆°ng th·ª©c</th>
        <th>Ghi ch√∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="summary"></div>
</section>
</main>

<!-- Popup T·∫°o Phi·∫øu Chi -->
<div id="popupChi" class="popup">
  <div class="popup-content">
    <h2>üí∏ T·∫°o Phi·∫øu Chi</h2>
    <div class="form-group">
      <label>S·ªë ti·ªÅn</label>
      <input type="text" id="chiAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" />
    </div>
    <div class="form-group">
      <label>Kho chi</label>
      <select 
        id="chiKho"
        data-permission-key="donhangCreate"
        data-permission-action="EditStoreID"
        data-permission-behavior="disable">
      </select>
    </div>    
    <div class="form-group">
      <label>N·ªôi dung chi</label>
      <input type="text" id="chiNoiDung" placeholder="N·ªôi dung chi" />
    </div>
    <div class="form-group">
      <label>M·ª•c kho·∫£n chi</label>
      <select id="chiMucKhoan">
        <option value="Chi ti·ªÅn ƒëi·ªán - n∆∞·ªõc">Chi ti·ªÅn ƒëi·ªán - n∆∞·ªõc</option>
        <option value="Chi ti·ªÅn n∆∞·ªõc gi·∫∑t - s·∫£">Chi ti·ªÅn n∆∞·ªõc gi·∫∑t - s·∫£</option>
        <option value="Chi ti·ªÅn v·ªá sinh">Chi ti·ªÅn v·ªá sinh</option>
        <option value="Chi ph√≠ kh√°c">Chi ti·ªÅn kh√°c</option>
      </select>
    </div>
    <div class="form-group">
      <label>Ti·ªÅn m·∫∑t</label>
      <input type="text" id="chiCash" placeholder="Ti·ªÅn m·∫∑t" />
    </div>
    <div class="form-group">
      <label>Chuy·ªÉn kho·∫£n</label>
      <input type="text" id="chiBank" placeholder="Chuy·ªÉn kho·∫£n" />
    </div>
    <div class="form-group">
      <label>C√≤n n·ª£</label>
      <input type="text" id="chiConNo" placeholder="C√≤n n·ª£" readonly />
    </div>
    <div class="popup-buttons">
      <button id="btnSaveChi" class="btn success">üíæ L∆∞u</button>
      <button id="btnCancelChi" class="btn">‚ùå H·ªßy</button>
    </div>
  </div>
</div>

<!-- Popup Chi Ti·∫øt Phi·∫øu -->
<div id="popupDetail" class="popup">
  <div class="popup-content">
    <h2>üìÑ Chi Ti·∫øt Phi·∫øu Thu - Chi</h2>
    <div id="detailInfo"></div>
    <h3>L·ªãch s·ª≠ thu chi</h3>
    <div class="history-table-wrapper">
      <table id="detailHistory">
        <thead>
          <tr>
            <th>Ti·ªÅn m·∫∑t</th>
            <th>Chuy·ªÉn kho·∫£n</th>
            <th>Ghi ch√∫</th>
            <th>User</th>
            <th>Ng√†y</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="addPaymentSection">
      <h3>üí∞ Chi ti·ªÅn</h3>
      <div class="form-group">
        <label>Ti·ªÅn m·∫∑t</label>
        <input type="text" id="detailCash" placeholder="Ti·ªÅn m·∫∑t" />
      </div>
      <div class="form-group">
        <label>Chuy·ªÉn kho·∫£n</label>
        <input type="text" id="detailBank" placeholder="Chuy·ªÉn kho·∫£n" />
      </div>
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <input type="text" id="detailNote" placeholder="Ghi ch√∫" />
      </div>
      <div class="popup-buttons">
        <button id="btnAddPayment" class="btn success">üí∞ Chi</button>
        <button id="btnCloseDetail" class="btn">‚ùå ƒê√≥ng</button>
      </div>
      <div class="popup-buttons" style="margin-bottom:10px;">
        <button id="btnEditTransaction" class="btn primary">‚úèÔ∏è Ch·ªânh s·ª≠a phi·∫øu</button>
      </div>      
    </div>
  </div>
</div>

<!-- Scripts -->
<script type="module" src="js/firebaseConfig.js"></script>
<script type="module" src="js/thuchi.js" defer></script>
<script type="module" src="js/menu.js" defer></script>
</body>
</html>
