<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>üë§ Qu·∫£n l√Ω kh√°ch h√†ng</title>
  <link rel="stylesheet" href="css/style.css" />

  <!-- ‚õî ·∫®n trang cho ƒë·∫øn khi ki·ªÉm tra quy·ªÅn xong -->
  <style>
    html, body {
      visibility: hidden;
      background: #f4f6f8;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    }
  </style>

  <!-- üîí Ki·ªÉm tra quy·ªÅn & ƒë·ªìng b·ªô login -->
  <script type="module">
    import { initProtectedPage } from "./js/permissionInit.js";
    // ‚úÖ Ch·ªâ c·∫ßn d√≤ng n√†y th√¥i, n√≥ x·ª≠ l√Ω h·∫øt (login, quy·ªÅn, UI, logout ƒë·ªìng b·ªô)
    await initProtectedPage("donhangCreate", "view");
  </script>
</head>

<body>
  <!-- üî∏ Menu chung -->
  <div id="menu"></div>

  <main class="container">
    <h1>üë§ Qu·∫£n l√Ω kh√°ch h√†ng</h1>

    <!-- üîç Thanh c√¥ng c·ª• -->
    <div class="toolbar">
      <button id="btnOpenAddKH" class="btn-add" data-permission-key="khachhangManage" data-permission-action="create">
        ‚ûï Th√™m kh√°ch h√†ng
      </button>

      <div class="search-area">
        <input type="text" id="searchKH" placeholder="üîç T√¨m theo t√™n ho·∫∑c SƒêT..." />
        <button id="btnSearchKH" class="btn-search">T√¨m</button>
        <button id="btnClearKH" class="btn-clear">‚ùå X√≥a t√¨m</button>
      </div>
    </div>

    <!-- üß© Modal th√™m kh√°ch h√†ng -->
    <div id="addModalKH" class="modal">
      <div class="modal-content">
        <h2>‚ûï Th√™m kh√°ch h√†ng m·ªõi</h2>
        <form id="formKhachHang" class="form-edit">
          <div class="form-grid">
            <div class="form-group">
              <label for="sdt">S·ªë ƒëi·ªán tho·∫°i (UID)</label>
              <input type="text" id="sdt" name="sdt" placeholder="VD: 0912345678" required pattern="[0-9]{9,11}" />
            </div>

            <div class="form-group">
              <label for="hoTen">H·ªç v√† t√™n</label>
              <input type="text" id="hoTen" name="hoTen" required />
            </div>

            <div class="form-group full">
              <label>ƒê·ªãa ch·ªâ</label>
              <div class="address-row">
                <input type="text" id="tinh" placeholder="T·ªânh/TP" required />
                <input type="text" id="phuong" placeholder="Ph∆∞·ªùng/X√£" required />
                <input type="text" id="duong" placeholder="T√™n ƒë∆∞·ªùng, s·ªë nh√†" required />
              </div>
            </div>

            <div class="form-group full">
              <label>Gi·ªõi t√≠nh</label>
              <div class="gender-group">
                <label><input type="radio" name="gioiTinh" value="Nam" required /> Nam</label>
                <label><input type="radio" name="gioiTinh" value="N·ªØ" /> N·ªØ</label>
                <label><input type="radio" name="gioiTinh" value="Kh√°c" /> Kh√°c</label>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn-save">üíæ L∆∞u</button>
            <button type="button" id="cancelAddKH" class="btn-cancel">‚ùå H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- üß© Modal ch·ªânh s·ª≠a kh√°ch h√†ng -->
    <div id="editModalKH" class="modal">
      <div class="modal-content">
        <h2>‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin kh√°ch h√†ng</h2>
        <form id="formEditKH" class="form-edit">
          <input type="hidden" id="editUid" />
          <div class="form-grid">
            <div class="form-group">
              <label for="editHoTen">H·ªç v√† t√™n</label>
              <input type="text" id="editHoTen" required />
            </div>

            <div class="form-group">
              <label for="editSdt">S·ªë ƒëi·ªán tho·∫°i (kh√¥ng ƒë·ªïi)</label>
              <input type="text" id="editSdt" disabled />
            </div>

            <div class="form-group full">
              <label>ƒê·ªãa ch·ªâ</label>
              <div class="address-row">
                <input type="text" id="editTinh" placeholder="T·ªânh/TP" required />
                <input type="text" id="editPhuong" placeholder="Ph∆∞·ªùng/X√£" required />
                <input type="text" id="editDuong" placeholder="T√™n ƒë∆∞·ªùng, s·ªë nh√†" required />
              </div>
            </div>

            <div class="form-group full">
              <label>Gi·ªõi t√≠nh</label>
              <div class="gender-group">
                <label><input type="radio" name="editGioiTinh" value="Nam" required /> Nam</label>
                <label><input type="radio" name="editGioiTinh" value="N·ªØ" /> N·ªØ</label>
                <label><input type="radio" name="editGioiTinh" value="Kh√°c" /> Kh√°c</label>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn-save">üíæ L∆∞u</button>
            <button type="button" id="cancelEditKH" class="btn-cancel">‚ùå H·ªßy</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ‚ö†Ô∏è Modal c·∫£nh b√°o tr√πng -->
    <div id="alertDuplicateKH" class="modal">
      <div class="modal-content">
        <h3>‚ö†Ô∏è Kh√°ch h√†ng ƒë√£ t·ªìn t·∫°i</h3>
        <p id="duplicateMsg"></p>
        <div class="modal-actions">
          <button id="closeDuplicateKH" class="btn-cancel">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <!-- üìã B·∫£ng danh s√°ch kh√°ch h√†ng -->
    <table class="data-table">
      <thead>
        <tr>
          <th>UID (SƒêT)</th>
          <th>H·ªç t√™n</th>
          <th>ƒê·ªãa ch·ªâ</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="listKhachHang">
        <!-- JS s·∫Ω render t·∫°i ƒë√¢y -->
      </tbody>
    </table>
  </main>

  <!-- üîß Script -->
  <script type="module" src="js/firebaseConfig.js"></script>
  <script type="module" src="js/menu.js"></script>
  <script type="module" src="js/khachhang.js"></script>

  <!-- üëÄ √Åp d·ª•ng ph√¢n quy·ªÅn UI -->
  <script type="module">
    import { applyPermissionUI } from "./js/checkPermission.js";
    await applyPermissionUI();
    document.body.style.visibility = "visible";
  </script>
</body>
</html>
